var RTOOLBAR={};(function(a){jQuery.fn.redactor=function(c){return this.each(function(){var d=a(this);var e=d.data("redactor");if(!e)d.data("redactor",e=new b(this,c))})};var b=function(b,c){this.$el=a(b);this.opts=a.extend({lang:"en",toolbar:"default",load:true,path:false,css:"style.css",focus:true,resize:true,autoresize:false,fixed:false,autoformat:true,cleanUp:true,convertDivs:true,removeClasses:true,removeStyles:false,convertLinks:true,handler:false,autosave:false,interval:60,imageGetJson:false,imageUpload:false,linkFileUpload:false,fileUpload:false,visual:true,fullscreen:false,overlay:true,colors:Array("#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"),allEmptyHtml:"<p><br /></p>",mozillaEmptyHtml:"<p> </p>"},c,this.$el.data());this.dropdowns=[];this.init()};b.prototype={_loadFile:function(b,c){var d=c[0];c.splice(0,1);var e;if(typeof d=="function")e=d;else e=a.proxy(function(){this._loadFile(d,c)},this);this.dynamicallyLoad(b,e)},loadFiles:function(a){var b=a[0];a.splice(0,1);this._loadFile(b,a)},dynamicallyLoad:function(a,b){var c=document.getElementsByTagName("head")[0];var d=document.createElement("script");d.src=a;var e=false;d.onload=d.onreadystatechange=function(){if(!e&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){e=true;if(b)b();d.onload=d.onreadystatechange=null}};c.appendChild(d)},init:function(){this.getPath();if(this.opts.load){var b=[];b.push(this.opts.path+"/langs/"+this.opts.lang+".js");if(this.opts.toolbar!==false)b.push(this.opts.path+"/toolbars/"+this.opts.toolbar+".js");b.push(a.proxy(this.start,this));this.loadFiles(b)}else this.start()},start:function(){this.height=this.$el.css("height");this.width=this.$el.css("width");this.build();var b=this.$el.val();b=this.preformater(b);if(this.opts.autoformat)b=this.paragraphy(b);this.$editor=this.enable(b);a(this.doc).click(a.proxy(function(a){this.$editor.focus()},this));a(this.doc).bind("paste",a.proxy(function(b){setTimeout(a.proxy(function(){var b=a('<span id="pastemarkerend"> </span>');this.insertNodeAtCaret(b.get(0));this.pasteCleanUp()},this),200)},this));a(this.doc).keypress(a.proxy(function(a){var b=a.keyCode||a.which;if(navigator.userAgent.indexOf("AppleWebKit")!=-1)return this.safariShiftKeyEnter(a,b)},this)).keyup(a.proxy(function(a){var b=a.keyCode||a.which;if(this.opts.autoformat){if(b==8||b==46)return this.formatEmpty(a);if(b==13&&!a.shiftKey&&!a.ctrlKey&&!a.metaKey)return this.formatNewLine(a)}this.syncCode()},this));this.buildToolbar();if(this.opts.autoresize===false)this.buildResizer();else this.observeAutoResize();this.shortcuts();this.autoSave();this.observeImages();if(this.opts.focus)this.focus();if(this.opts.fixed){this.observeScroll();a(document).scroll(a.proxy(this.observeScroll,this))}},shortcuts:function(){a(this.doc).keydown(a.proxy(function(a){var b=a.keyCode||a.which;if(a.ctrlKey){if(b==90)this._shortcuts(a,"undo");else if(b==90&&a.shiftKey)this._shortcuts(a,"redo");else if(b==77)this._shortcuts(a,"removeFormat");else if(b==66)this._shortcuts(a,"bold");else if(b==73)this._shortcuts(a,"italic");else if(b==74)this._shortcuts(a,"insertunorderedlist");else if(b==75)this._shortcuts(a,"insertorderedlist");else if(b==76)this._shortcuts(a,"superscript")}if(!a.shiftKey&&b==9)this._shortcuts(a,"indent");else if(a.shiftKey&&b==9)this._shortcuts(a,"outdent")},this))},_shortcuts:function(a,b){if(a.preventDefault)a.preventDefault();this.execCommand(b,null)},getPath:function(){if(this.opts.path!==false)return this.opts.path;a("script").each(a.proxy(function(a,b){if(b.src){var c=new RegExp(/\/redactor\.min\.js|\/redactor\.js/);if(b.src.match(c))this.opts.path=b.src.replace(c,"")}},this))},build:function(){this.$box=a('<div class="redactor_box"></div>');this.$frame=a('<iframe frameborder="0" scrolling="auto" style="height: '+this.height+';" class="redactor_frame"></iframe>');this.$el.css("width","100%").hide();this.$box.insertAfter(this.$el).append(this.$frame).append(this.$el)},write:function(a){this.doc.open();this.doc.write(a);this.doc.close()},enable:function(b){this.doc=this.getDoc(this.$frame.get(0));if(this.doc!==null){this.write(this.setDoc(b));if(a.browser.mozilla)this.doc.execCommand("useCSS",false,true);return a(this.doc).find("#page")}else return false},setDoc:function(a){var b="<!DOCTYPE html>\n";b+='<html><head><link media="all" type="text/css" href="'+this.opts.path+"/css/"+this.opts.css+'" rel="stylesheet"></head>';b+='<body><div id="page" contenteditable="true">';b+=a;b+="</div></body></html>";return b},getDoc:function(a){if(a.contentDocument)return a.contentDocument;else if(a.contentWindow&&a.contentWindow.document)return a.contentWindow.document;else if(a.document)return a.document;else return null},focus:function(){this.$editor.focus()},syncCode:function(){var a=this.formating(this.$editor.html());this.$el.val(a)},setCode:function(a){a=this.preformater(a);this.$editor.html(a).focus();this.syncCode()},getCode:function(){var a=this.$editor?this.$editor.html():this.$el.val();a=this.reformater(a);return a},insertHtml:function(a){this.execCommand("inserthtml",a)},destroy:function(){var a=this.getCode();this.$box.after(this.$el);this.$box.remove();this.$el.val(a).show();this.dropdowns.forEach(function(a,b){a.remove();delete this.dropdowns[b]},this)},handler:function(){a.ajax({url:this.opts.handler,type:"post",data:"redactor="+escape(encodeURIComponent(this.getCode())),success:a.proxy(function(a){this.setCode(a);this.syncCode()},this)})},observeImages:function(){if(a.browser.mozilla)this.doc.execCommand("enableObjectResizing",false,"false");a(this.doc).find("img").attr("unselectable","on").each(a.proxy(function(a,b){this.resizeImage(b)},this))},observeScroll:function(){var b=a(document).scrollTop();var c=this.$box.offset().top;if(b>c){this.fixed=true;this.$toolbar.css({position:"fixed",width:"100%"})}else{this.fixed=false;this.$toolbar.css({position:"relative",width:"auto"})}},observeAutoResize:function(){this.setAutoSize();a(this.doc).keyup(a.proxy(this.setAutoSize,this))},setAutoSize:function(){var a=parseInt(this.height.replace("px",""));var b=this.getEditorHeight();if(b<=a)b=a+40;else b+=40;this.$frame.height(b);this.$el.height(b)},getEditorHeight:function(){return this.$editor.height()+this.normalize(this.$editor.css("margin-top"))+this.normalize(this.$editor.css("margin-bottom"))+this.normalize(this.$editor.css("padding-top"))+this.normalize(this.$editor.css("padding-bottom"))},execCommand:function(b,c){if(this.opts.visual&&this.doc){try{if(a.browser.msie)this.focus();if(b=="inserthtml"&&a.browser.msie)this.doc.selection.createRange().pasteHTML(c);else if(b=="formatblock"&&a.browser.msie)this.doc.execCommand(b,false,"<"+c+">");else{this.doc.execCommand(b,false,c)}this.syncCode();this.focus()}catch(d){}}},formatNewLine:function(b){var c=this.getParentNode();if(c.nodeName=="DIV"&&c.id=="page"){if(b.preventDefault)b.preventDefault();element=a(this.getCurrentNode());if(element.get(0).tagName=="DIV"){newElement=a("<p>").append(element.clone().get(0).childNodes);element.replaceWith(newElement);newElement.html("<br />");this.setFocusNode(newElement.get(0));this.syncCode();return false}else this.syncCode();if(this.opts.convertLinks)this.$editor.linkify()}else{this.syncCode();return true}},safariShiftKeyEnter:function(b,c){if(b.shiftKey&&c==13){if(b.preventDefault)b.preventDefault();var d=a("<span><br /></span>");this.insertNodeAtCaret(d.get(0));this.setFocusNode(d.get(0));this.syncCode();return false}},formatEmpty:function(b){var c=a.trim(this.$editor.html());if(a.browser.mozilla)c=c.replace(/<br>/gi,"");if(c===""){if(b.preventDefault)b.preventDefault();var d=this.opts.allEmptyHtml;if(a.browser.mozilla)d=this.opts.mozillaEmptyHtml;var e=a(d).get(0);this.$editor.html(e);this.setFocusNode(e);this.syncCode();return false}else this.syncCode()},paragraphy:function(b){b=a.trim(b);if(b===""){if(!a.browser.mozilla)return this.opts.allEmptyHtml;else return this.opts.mozillaEmptyHtml}if(this.opts.convertDivs)b=b.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>");var c=function(a,b,c){return a.replace(new RegExp(b,"g"),c)};var d=function(a,d){return c(b,a,d)};var e="(table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|style|script|object|input|param|p|h[1-6])";b+="\n";d("<br />\\s*<br />","\n\n");d("(<"+e+"[^>]*>)","\n$1");d("(</"+e+">)","$1\n\n");d("\r\n|\r","\n");d("\n\n+","\n\n");d("\n?((.|\n)+?)$","<p>$1</p>\n");d("<p>\\s*?</p>","");d("<p>(<div[^>]*>\\s*)","$1<p>");d("<p>([^<]+)\\s*?(</(div|address|form)[^>]*>)","<p>$1</p>$2");d("<p>\\s*(</?"+e+"[^>]*>)\\s*</p>","$1");d("<p>(<li.+?)</p>","$1");d("<p>\\s*(</?"+e+"[^>]*>)","$1");d("(</?"+e+"[^>]*>)\\s*</p>","$1");d("(</?"+e+"[^>]*>)\\s*<br />","$1");d("<br />(\\s*</?(p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","$1");if(b.indexOf("<pre")!=-1){d("(<pre(.|\n)*?>)((.|\n)*?)</pre>",function(a,b,d,e){return c(b,"\\\\(['\"\\\\])","$1")+c(c(c(e,"<p>","\n"),"</p>|<br />",""),"\\\\(['\"\\\\])","$1")+"</pre>"})}return d("\n</p>$","</p>")},preformater:function(a){a=a.replace(/<br>/gi,"<br />");a=a.replace(/<blockquote\b[^>]*>([\w\W]*?)<p>([\w\W]*?)<\/p>([\w\W]*?)<\/blockquote[^>]*>/gi,"<blockquote>$1$2<br />$3</blockquote>");a=a.replace(/<strong\b[^>]*>([\w\W]*?)<\/strong[^>]*>/gi,"<b>$1</b>");a=a.replace(/<em\b[^>]*>([\w\W]*?)<\/em[^>]*>/gi,"<i>$1</i>");a=a.replace(/<del\b[^>]*>([\w\W]*?)<\/del[^>]*>/gi,"<strike>$1</strike>");return a},reformater:function(a){a=a.replace(/<br>/gi,"<br />");a=a.replace(/<b\b[^>]*>([\w\W]*?)<\/b[^>]*>/gi,"<strong>$1</strong>");a=a.replace(/<i\b[^>]*>([\w\W]*?)<\/i[^>]*>/gi,"<em>$1</em>");a=a.replace(/<strike\b[^>]*>([\w\W]*?)<\/strike[^>]*>/gi,"<del>$1</del>");a=a.replace(/<span(.*?)style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<strong>$2</strong>");a=a.replace(/<span(.*?)style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<em>$2</em>");a=a.replace(/<span(.*?)style="font-weight: bold; font-style: italic;">([\w\W]*?)<\/span>/gi,"<em><strong>$2</strong></em>");a=a.replace(/<span(.*?)style="font-style: italic; font-weight: bold;">([\w\W]*?)<\/span>/gi,"<strong><em>$2</em></strong>");return a},cleanUpClasses:function(a){a=a.replace(/\s*class="TOC(.*?)"/gi,"");a=a.replace(/\s*class="Heading(.*?)"/gi,"");a=a.replace(/\s*class="Body(.*?)"/gi,"");return a},cleanUpStyles:function(a){a=a.replace(/\s*mso-[^:]+:[^;"]+;?/gi,"");a=a.replace(/\s*margin(.*?)pt\s*;/gi,"");a=a.replace(/\s*margin(.*?)cm\s*;/gi,"");a=a.replace(/\s*text-indent:(.*?)\s*;/gi,"");a=a.replace(/\s*line-height:(.*?)\s*;/gi,"");a=a.replace(/\s*page-break-before: [^\s;]+;?"/gi,'"');a=a.replace(/\s*font-variant: [^\s;]+;?"/gi,'"');a=a.replace(/\s*tab-stops:[^;"]*;?/gi,"");a=a.replace(/\s*tab-stops:[^"]*/gi,"");a=a.replace(/\s*face="[^"]*"/gi,"");a=a.replace(/\s*face=[^ >]*/gi,"");a=a.replace(/\s*font:(.*?);/gi,"");a=a.replace(/\s*font-size:(.*?);/gi,"");a=a.replace(/\s*font-weight:(.*?);/gi,"");a=a.replace(/\s*font-family:[^;"]*;?/gi,"");a=a.replace(/<span style="Times New Roman"">\s\n<\/span>/gi,"");return a},cleanUp:function(a){a=a.replace(/(<\!\-\-([\w\W]*?)\-\->)/ig,"");if(this.opts.convertDivs){a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>")}a=a.replace(/ lang="([\w\W]*?)"/gi,"");a=a.replace(/<a name="(.*?)">([\w\W]*?)<\/a>/gi,"");a=a.replace(/\ \ \ /gi," ");a=a.replace(/\ \ /gi," ");a=a.replace(/<o:p>(.*?)<\/o:p>/gi,"");a=a.replace(/\s*style="\s*"/gi,"");a=a.replace(/<span> <\/span>/gi,"");a=a.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");return a},removeTags:function(a){return a.replace(/<(?!\s*\/?(code|span|div|label|a|br|p|b|i|del|strike|img|video|audio|iframe|object|embed|param|blockquote|mark|cite|small|ul|ol|li|hr|dl|dt|dd|sup|sub|big|pre|code|figure|figcaption|strong|em|table|tr|td|th|tbody|thead|tfoot|h1|h2|h3|h4|h5|h6)\b)[^>]+>/gi,"")},pasteCleanUp:function(){var b=this.$editor.html();b=b.replace(/<span id="pastemarkerend"> <\/span>/,"#marker#");b=this.formating(b);b=this.cleanUp(b);if(this.opts.removeClasses)b=b.replace(/ class="([\w\W]*?)"/gi,"");else b=this.cleanUpClasses(b);if(this.opts.removeStyles)b=b.replace(/ style="([\w\W]*?)"/gi,"");else b=this.cleanUpStyles(b);b=this.cleanUp(b);b=this.formating(b);b=b.replace(/#marker#/,'<span id="pastemarkerend"> </span>');this.$editor.html(b);var c=a(this.doc.body).find("#pastemarkerend").get(0);this.setFocusNode(c);this.syncCode()},formating:function(b){if(a.browser.msie){b=b.replace(/<*(\/ *)?(\w+)/g,function(a){return a.toLowerCase()});b=b.replace(/style="(.*?)"/g,function(a){return a.toLowerCase()});b=b.replace(/ jQuery(.*?)=\"(.*?)\"/gi,"")}b=b.replace(/<font([\w\W]*?)color="(.*?)">([\w\W]*?)<\/font\>/gi,'<span style="color: $2;">$3</span>');b=b.replace(/<font([\w\W]*?)>([\w\W]*?)<\/font\>/gi,"<span$1>$2</span>");b=b.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");b=b.replace(/ class="Apple-style-span"/gi,"");b=b.replace(/ class="Apple-tab-span"/gi,"");b=b.replace(/<p><p>/g,"<p>");b=b.replace(/<\/p><\/p>/g,"</p>");b=b.replace(/<hr(.*?)>/g,"<hr />");b=b.replace(/<p> /g,"<p>");b=b.replace(/<p><ul>/g,"<ul>");b=b.replace(/<p><ol>/g,"<ol>");b=b.replace(/<\/ul><\/p>/g,"</ul>");b=b.replace(/<\/ol><\/p>/g,"</ol>");b=b.replace(/<p(.*?)> <\/p>/gi,"");b=b.replace(/[\t]*/g,"");b=b.replace(/\n\s*\n/g,"\n");b=b.replace(/^[\s\n]*/,"");b=b.replace(/[\s\n]*$/,"");var c=["<pre></pre>","<blockquote></blockquote>","<em></em>","<b></b>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span><span>","<span> <span>","<p> </p>","<p></p>","<p> </p>","<p><br></p>","<div></div>"];for(var d=0;d<c.length;++d){var e=c[d];b=b.replace(new RegExp(e,"gi"),"")}var f="\r\n";var g=["<form","<fieldset","<legend","<object","<embed","<select","<option","<input","<textarea","<pre","<blockquote","<ul","<ol","<li","<dl","<dt","<dd","<table","<thead","<tbody","<caption","</caption>","<th","<tr","<td","<figure"];for(var d=0;d<g.length;++d){var h=g[d];b=b.replace(new RegExp(h,"gi"),f+h)}var i=["</p>","</div>","</ul>","</ol>","</h1>","</h2>","</h3>","</h4>","</h5>","</h6>","<br>","<br />","</dl>","</dt>","</dd>","</form>","</blockquote>","</pre>","</legend>","</fieldset>","</object>","</embed>","</textarea>","</select>","</option>","</table>","</thead>","</tbody>","</tr>","</td>","</th>","</figure>"];for(var d=0;d<i.length;++d){var j=i[d];b=b.replace(new RegExp(j,"gi"),j+f)}b=b.replace(/<li/g,"	<li");b=b.replace(/<tr/g,"	<tr");b=b.replace(/<td/g,"		<td");b=b.replace(/<\/tr>/g,"	</tr>");return b},toggle:function(){var b;if(this.opts.visual){this.$frame.hide();b=this.$editor.html();b=a.trim(this.formating(b));this.$el.val(b).show();this.setBtnActive("html");this.opts.visual=false}else{this.$el.hide();this.$editor.html(this.$el.val());this.$frame.show();if(this.$editor.html()===""){if(!a.browser.mozilla)b=this.opts.allEmptyHtml;else b=this.opts.mozillaEmptyHtml;this.setCode(b)}this.focus();this.setBtnInactive("html");this.opts.visual=true;this.observeImages()}},autoSave:function(){if(this.opts.autosave===false)return false;setInterval(a.proxy(function(){a.post(this.opts.autosave,{data:this.getCode()})},this),this.opts.interval*1e3)},buildToolbar:function(){if(this.opts.toolbar===false)return false;this.$toolbar=a("<ul>").addClass("redactor_toolbar");this.$box.prepend(this.$toolbar);a.each(RTOOLBAR[this.opts.toolbar],a.proxy(function(b,c){var d=a("<li>");if(b=="fullscreen")a(d).addClass("redactor_toolbar_right");var e=this.buildButton(b,c);if(b=="backcolor"||b=="fontcolor"||typeof c.dropdown!="undefined"){var f=a('<div class="redactor_dropdown" style="display: none;">');if(b=="backcolor"||b=="fontcolor")f=this.buildColorPicker(f,b);else f=this.buildDropdown(f,c.dropdown);this.dropdowns.push(f.appendTo(a(document.body)));this.hdlHideDropDown=a.proxy(function(a){this.hideDropDown(a,f,b)},this);this.hdlShowDropDown=a.proxy(function(a){this.showDropDown(a,f,b)},this);e.click(this.hdlShowDropDown)}this.$toolbar.append(a(d).append(e));if(typeof c.separator!="undefined")this.$toolbar.append(a('<li class="redactor_separator"></li>'))},this));a(document).click(this.hdlHideDropDown);a(this.doc).click(this.hdlHideDropDown)},buildButton:function(b,c){var d=a('<a href="javascript:void(null);" title="'+c.title+'" class="redactor_btn_'+b+'"><span> </span></a>');if(typeof c.func=="undefined")d.click(a.proxy(function(){this.execCommand(c.exec,b)},this));else if(c.func!="show")d.click(a.proxy(function(a){this[c.func](a)},this));return d},buildDropdown:function(b,c){a.each(c,a.proxy(function(c,d){if(typeof d.style=="undefined")d.style="";var e;if(d.name=="separator")e=a('<a class="redactor_separator_drop">');else{e=a('<a href="javascript:void(null);" style="'+d.style+'">'+d.title+"</a>");if(typeof d.func=="undefined")a(e).click(a.proxy(function(){this.execCommand(d.exec,c)},this));else a(e).click(a.proxy(function(a){this[d.func](a)},this))}a(b).append(e)},this));return b},buildColorPicker:function(b,c){var d;if(c=="backcolor"){if(a.browser.msie)d="BackColor";else d="hilitecolor"}else d="forecolor";a(b).width(210);var e=this.opts.colors.length;for(var f=0;f<e;++f){var g=this.opts.colors[f];var h=a('<a rel="'+g+'" href="javascript:void(null);" class="redactor_color_link"></a>').css({backgroundColor:g});a(b).append(h);var i=this;a(h).click(function(){i.execCommand(d,a(this).attr("rel"))})}var j=a('<a href="javascript:void(null);" class="redactor_color_none"></a>').html(RLANG.none);if(c=="backcolor")j.click(a.proxy(this.setBackgroundNone,this));else j.click(a.proxy(this.setColorNone,this));a(b).append(j);return b},setBackgroundNone:function(){a(this.getParentNode()).css("background-color","transparent");this.syncCode()},setColorNone:function(){a(this.getParentNode()).attr("color","").css("color","");this.syncCode()},showDropDown:function(b,c,d){this.hideAllDropDown();this.setBtnActive(d);this.getBtn(d).addClass("dropact");var e=this.getBtn(d).offset().left;if(this.opts.fixed&&this.fixed){a(c).css({position:"fixed",left:e+"px",top:"30px"}).show()}else{var f=this.$toolbar.offset().top+30;a(c).css({position:"absolute",left:e+"px",top:f+"px"}).show()}},hideAllDropDown:function(){this.$toolbar.find("a.dropact").removeClass("act").removeClass("dropact");a(".redactor_dropdown").hide()},hideDropDown:function(b,c,d){if(!a(b.target).parent().hasClass("dropact")){a(c).removeClass("act");this.showedDropDown=false;this.hideAllDropDown()}},getSelection:function(){if(this.$frame.get(0).contentWindow.getSelection)return this.$frame.get(0).contentWindow.getSelection();else if(this.$frame.get(0).contentWindow.document.selection)return this.$frame.get(0).contentWindow.document.selection.createRange()},getParentNode:function(){if(window.getSelection)return this.getSelection().getRangeAt(0).startContainer.parentNode;else if(document.selection)return this.getSelection().parentElement()},getCurrentNode:function(){if(window.getSelection)return this.getSelection().getRangeAt(0).startContainer;else if(document.selection)return this.getSelection()},setFocusNode:function(a,b){var c=this.doc.createRange();var d=this.getSelection();b=b?0:1;if(d!==null){c.selectNodeContents(a);d.addRange(c);d.collapse(a,b)}this.focus()},insertNodeAtCaret:function(a){if(typeof window.getSelection!="undefined"){var b=this.getSelection();if(b.rangeCount){var c=b.getRangeAt(0);c.collapse(false);c.insertNode(a);c=c.cloneRange();c.selectNodeContents(a);c.collapse(false);b.removeAllRanges();b.addRange(c)}}else if(typeof document.selection!="undefined"&&document.selection.type!="Control"){var d=a.nodeType==1?a.outerHTML:a.data;var e="marker_"+(""+Math.random()).slice(2);d+='<span id="'+e+'"></span>';var f=this.getSelection();f.collapse(false);f.pasteHTML(d);var g=document.getElementById(e);f.moveToElementText(g);f.select();g.parentNode.removeChild(g)}},getBtn:function(b){return a(this.$toolbar.find("a.redactor_btn_"+b))},setBtnActive:function(a){this.getBtn(a).addClass("act")},setBtnInactive:function(a){this.getBtn(a).removeClass("act")},changeBtnIcon:function(a,b){this.getBtn(a).addClass("redactor_btn_"+b)},removeBtnIcon:function(a,b){this.getBtn(a).removeClass("redactor_btn_"+b)},removeBtn:function(a){this.getBtn(a).remove()},addBtn:function(b,c){this.$toolbar.append(a("<li>").append(this.buildButton(b,c)))},fullscreen:function(){var b;if(this.opts.fullscreen===false){this.changeBtnIcon("fullscreen","normalscreen");this.setBtnActive("fullscreen");this.opts.fullscreen=true;this.height=this.$frame.css("height");this.width=this.$box.width()-2+"px";b=this.getCode();this.tmpspan=a("<span></span>");this.$box.addClass("redactor_box_fullscreen").after(this.tmpspan);a(document.body).prepend(this.$box).css("overflow","hidden");this.$editor=this.enable(b);a(this.doc).click(a.proxy(this.hideAllDropDown,this));a(this.doc).click(a.proxy(function(a){this.$editor.focus()},this));this.observeImages();this.fullScreenResize();a(window).resize(a.proxy(this.fullScreenResize,this));a(document).scrollTop(0,0);this.focus()}else{this.removeBtnIcon("fullscreen","normalscreen");this.setBtnInactive("fullscreen");this.opts.fullscreen=false;a(window).unbind("resize",a.proxy(this.fullScreenResize,this));a(document.body).css("overflow","");b=this.getCode();this.$box.removeClass("redactor_box_fullscreen").css("width","auto");this.tmpspan.after(this.$box).remove();this.$editor=this.enable(b);this.observeImages();this.observeAutoResize();a(this.doc).click(a.proxy(this.hideAllDropDown,this));a(this.doc).click(a.proxy(function(a){this.$editor.focus()},this));this.syncCode();this.$frame.css("height",this.height);this.$el.css("height",this.height);this.focus()}},fullScreenResize:function(){if(this.opts.fullscreen===false)return;var b=42;if(this.opts.air)b=2;var c=a(window).height()-b;this.$box.width(a(window).width()-2);this.$frame.height(c);this.$el.height(c)},buildResizer:function(){if(this.opts.resize===false)return false;this.$resizer=a('<div class="redactor_resizer">—</div>');this.$box.append(this.$resizer);this.$resizer.mousedown(a.proxy(this.initResize,this))},initResize:function(b){if(b.preventDefault)b.preventDefault();this.splitter=b.target;if(this.opts.visual){this.element_resize=this.$frame;this.element_resize.get(0).style.visibility="hidden";this.element_resize_parent=this.$el}else{this.element_resize=this.$el;this.element_resize_parent=this.$frame}this.stopResizeHdl=a.proxy(this.stopResize,this);this.startResizeHdl=a.proxy(this.startResize,this);this.resizeHdl=a.proxy(this.resize,this);a(document).mousedown(this.startResizeHdl);a(document).mouseup(this.stopResizeHdl);a(this.splitter).mouseup(this.stopResizeHdl);this.null_point=false;this.h_new=false;this.h=this.element_resize.height()},startResize:function(){a(document).mousemove(this.resizeHdl)},resize:function(a){if(a.preventDefault)a.preventDefault();var b=a.pageY;if(this.null_point===false)this.null_point=b;if(this.h_new===false)this.h_new=this.element_resize.height();var c=this.h_new+b-this.null_point-10;if(c<=30)return true;if(c>=0){this.element_resize.get(0).style.height=c+"px";this.element_resize_parent.get(0).style.height=c+"px"}},stopResize:function(b){a(document).unbind("mousemove",this.resizeHdl);a(document).unbind("mousedown",this.startResizeHdl);a(document).unbind("mouseup",this.stopResizeHdl);a(this.splitter).unbind("mouseup",this.stopResizeHdl);this.element_resize.get(0).style.visibility="visible"},resizeImage:function(b){var c=false;var d=false;var e;var f;var g=a(b).width()/a(b).height();var h=1;var i=1;var j=1;var k=1;a(b).hover(function(){a(b).css("cursor","nw-resize")},function(){a(b).css("cursor","auto");c=false});a(b).mousedown(function(g){if(g.preventDefault)g.preventDefault();c=true;d=true;e=Math.round(g.pageX-a(b).eq(0).offset().left);f=Math.round(g.pageY-a(b).eq(0).offset().top)});a(b).mouseup(a.proxy(function(a){c=false;this.syncCode()},this));a(b).click(a.proxy(function(a){if(d)this.imageEdit(a)},this));a(b).mousemove(function(l){if(c){d=false;var m=Math.round(l.pageX-a(this).eq(0).offset().left)-e;var n=Math.round(l.pageY-a(this).eq(0).offset().top)-f;var o=a(b).height();var p=parseInt(o)+n;var q=p*g;if(i==1||typeof i=="number"&&q<i&&q>j){a(b).width(q)}if(h==1||typeof h=="number"&&p<h&&p>k){a(b).height(p)}e=Math.round(l.pageX-a(this).eq(0).offset().left);f=Math.round(l.pageY-a(this).eq(0).offset().top)}})},showTable:function(){this.modalInit(RLANG.table,this.opts.path+"/plugins/table.html",230,a.proxy(function(){a("#redactor_table_rows").focus();a("#redactor_insert_table_btn").click(a.proxy(this.insertTable,this))},this))},insertTable:function(){var b=a("#redactor_table_rows").val();var c=a("#redactor_table_columns").val();var d=a("<div></div>");var e=Math.floor(Math.random()*99999);var f=a('<table id="table'+e+'"><tbody></tbody></table>');for(var g=0;g<b;g++){var h=a("<tr></tr>");for(var i=0;i<c;i++){var j=a("<td> </td>");a(h).append(j)}a(f).append(h)}a(d).append(f);var k=a(d).html();if(a.browser.msie)k+="<p></p>";else k+="<p> </p>";this.execCommand("inserthtml",k);this.modalClose();this.$table=a(this.doc).find("body").find("#table"+e);this.$table.click(a.proxy(this.tableObserver,this))},tableObserver:function(b){this.$table=a(b.target).parents("table");this.$table_tr=this.$table.find("tr");this.$table_td=this.$table.find("td");this.$table_td.removeClass("current");this.$tbody=a(b.target).parents("tbody");this.$thead=a(this.$table).find("thead");this.$current_td=a(b.target);this.$current_td.addClass("current");this.$current_tr=a(b.target).parents("tr")},deleteTable:function(){a(this.$table).remove();this.$table=false;this.syncCode()},deleteRow:function(){a(this.$current_tr).remove();this.syncCode()},deleteColumn:function(){var b=a(this.$current_td).get(0).cellIndex;a(this.$table).find("tr").each(function(){a(this).find("td").eq(b).remove()});this.syncCode()},addHead:function(){if(a(this.$table).find("thead").size()!==0)this.deleteHead();else{var b=a(this.$table).find("tr").first().clone();b.find("td").html(" ");this.$thead=a("<thead></thead>");this.$thead.append(b);a(this.$table).prepend(this.$thead);this.syncCode()}},deleteHead:function(){a(this.$thead).remove();this.$thead=false;this.syncCode()},insertRowAbove:function(){this.insertRow("before")},insertRowBelow:function(){this.insertRow("after")},insertColumnLeft:function(){this.insertColumn("before")},insertColumnRight:function(){this.insertColumn("after")},insertRow:function(b){var c=a(this.$current_tr).clone();c.find("td").html(" ");if(b=="after")a(this.$current_tr).after(c);else a(this.$current_tr).before(c);this.syncCode()},insertColumn:function(b){var c=0;this.$current_td.addClass("current");this.$current_tr.find("td").each(function(b,d){if(a(d).hasClass("current"))c=b});this.$table_tr.each(function(d,e){var f=a(e).find("td").eq(c);var g=f.clone();g.html(" ");if(b=="after")a(f).after(g);else a(f).before(g)});this.syncCode()},showVideo:function(){if(a.browser.msie)this.markerIE();this.modalInit(RLANG.video,this.opts.path+"/plugins/video.html",600,a.proxy(function(){a("#redactor_insert_video_area").focus();a("#redactor_insert_video_btn").click(a.proxy(this.insertVideo,this))},this))},insertVideo:function(){var b=a("#redactor_insert_video_area").val();if(a.browser.msie){a(this.doc.getElementById("span"+this.spanid)).after(b).remove();this.syncCode()}else this.execCommand("inserthtml",b);this.modalClose()},imageEdit:function(b){var c=a(b.target);var d=c.parent();var e=a.proxy(function(){a("#redactor_file_alt").val(c.attr("alt"));a("#redactor_image_edit_src").attr("href",c.attr("src"));a("#redactor_form_image_align").val(c.css("float"));if(a(d).get(0).tagName=="A")a("#redactor_file_link").val(a(d).attr("href"));a("#redactor_image_delete_btn").click(a.proxy(function(){this.imageDelete(c)},this));a("#redactorSaveBtn").click(a.proxy(function(){this.imageSave(c)},this))},this);this.modalInit(RLANG.image,this.opts.path+"/plugins/image_edit.html",380,e)},imageDelete:function(b){a(b).remove();this.modalClose();this.syncCode()},imageSave:function(b){var c=a(b).parent();a(b).attr("alt",a("#redactor_file_alt").val());var d=a("#redactor_form_image_align").val();if(d=="left")a(b).css({"float":"left",margin:"0 10px 10px 0"});else if(d=="right")a(b).css({"float":"right",margin:"0 0 10px 10px"});else a(b).css({"float":"none",margin:"0"});var e=a.trim(a("#redactor_file_link").val());if(e!==""){if(a(c).get(0).tagName!="A"){a(b).replaceWith('<a href="'+e+'">'+this.outerHTML(b)+"</a>")}else{a(c).attr("href",e)}}this.modalClose();this.observeImages();this.syncCode()},showImage:function(){if(a.browser.msie)this.markerIE();var b=a.proxy(function(){if(this.opts.imageGetJson!==false){a.getJSON(this.opts.imageGetJson,a.proxy(function(b){a.each(b,a.proxy(function(b,c){var d=a('<img src="'+c.thumb+'" rel="'+c.image+'" alt="'+c.full+'" />');a("#redactor_image_box").append(d);a(d).click(a.proxy(this.imageSetThumb,this))},this))},this))}else{a("#redactor_tabs li").eq(1).remove()}if(a("#redactor_file").size()!==0){a("#redactor_file").dragupload({url:this.opts.imageUpload,success:a.proxy(this.imageUploadCallback,this)})}this.uploadInit("redactor_file",{auto:true,url:this.opts.imageUpload,success:a.proxy(this.imageUploadCallback,this)});a("#redactor_upload_btn").click(a.proxy(this.imageUploadCallbackLink,this))},this);this.modalInit(RLANG.image,this.opts.path+"/plugins/image.html",570,b,true)},imageSetThumb:function(b){this._imageSet('<a href="'+a(b.target).attr("alt")+'"><img alt="" src="'+a(b.target).attr("rel")+'" /></a>')},imageUploadCallbackLink:function(){if(a("#redactor_file_link").val()!==""){var b='<img src="'+a("#redactor_file_link").val()+'" />';this._imageSet(b)}else this.modalClose()},imageUploadCallback:function(a){this._imageSet(a)},_imageSet:function(b){b="<p>"+b+"</p>";this.focus();if(a.browser.msie){a(this.doc.getElementById("span"+this.spanid)).after(b).remove();this.syncCode()}else{this.execCommand("inserthtml",b)}this.modalClose();this.observeImages()},showLink:function(){var b=a.proxy(function(){var b=this.getSelection();if(a.browser.msie){var c=this.getParentNode();if(c.nodeName=="A"){this.insert_link_node=a(c);var d=this.insert_link_node.text();var e=this.insert_link_node.attr("href")}else{if(this.oldIE())var d=b.text;else var d=b.toString();var e="";this.spanid=Math.floor(Math.random()*99999);var f='<span id="span'+this.spanid+'">'+d+"</span>";if(d!="")f='<span id="span'+this.spanid+'">'+d+"</span>";this.execCommand("inserthtml",f)}}else{if(b&&b.anchorNode.parentNode.tagName=="A"){var e=b.anchorNode.parentNode.href;var d=b.anchorNode.parentNode.text;if(b.toString()==="")this.insert_link_node=b.anchorNode.parentNode}else{var d=b.toString();var e=""}}a(".redactor_link_text").val(d);a("#redactor_link_url").val(e).focus();a("#redactor_insert_link_btn").click(a.proxy(this.insertLink,this));if(a("#redactor_file").size()!=0){a("#redactor_file").dragupload({url:this.opts.linkFileUpload,success:a.proxy(this.insertLinkFile,this)})}this.uploadInit("redactor_file",{auto:true,url:this.opts.linkFileUpload,success:a.proxy(this.insertLinkFile,this)})},this);this.modalInit(RLANG.link,this.opts.path+"/plugins/link.html",460,b)},insertLink:function(){var b=a("#redactor_tab_selected").val();var c="",d="";if(b==1){c=a("#redactor_link_url").val();d=a("#redactor_link_url_text").val()}else if(b==2){c="mailto:"+a("#redactor_link_mailto").val();d=a("#redactor_link_mailto_text").val()}else if(b==3){c="#"+a("#redactor_link_anchor").val();d=a("#redactor_link_anchor_text").val()}this._insertLink('<a href="'+c+'">'+d+"</a> ",a.trim(d),c)},insertLinkFile:function(b){text=a("#redactor_link_file_text").val();this._insertLink('<a href="'+b+'">'+text+"</a> ",a.trim(text),b)},_insertLink:function(b,c,d){if(c!=""){if(this.insert_link_node){a(this.insert_link_node).text(c);a(this.insert_link_node).attr("href",d);this.syncCode()}else{if(a.browser.msie){a(this.doc.getElementById("span"+this.spanid)).replaceWith(b);this.syncCode()}else this.execCommand("inserthtml",b)}}this.modalClose()},showFile:function(){if(a.browser.msie)this.markerIE();var b=a.proxy(function(){a("#redactor_file").dragupload({url:this.opts.fileUpload,success:a.proxy(function(a){this.fileUploadCallback(a)},this)});this.uploadInit("redactor_file",{auto:true,url:this.opts.fileUpload,success:a.proxy(function(a){this.fileUploadCallback(a)},this)})},this);this.modalInit(RLANG.file,this.opts.path+"/plugins/file.html",500,b)},fileUploadCallback:function(b){if(a.browser.webkit&&!!window.chrome)b=b+" ";if(a.browser.msie){a(this.doc.getElementById("span"+this.spanid)).after(b).remove();this.syncCode()}else this.execCommand("inserthtml",b);this.modalClose()},modalInit:function(b,c,d,e,f){if(a("#redactor_modal_overlay").size()==0){this.overlay=a('<div id="redactor_modal_overlay" style="display: none;"></div>');a("body").prepend(this.overlay)}if(this.opts.overlay){a("#redactor_modal_overlay").show();a("#redactor_modal_overlay").click(a.proxy(this.modalClose,this))}if(a("#redactor_modal").size()==0){this.modal=a('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">×</div><div id="redactor_modal_header"></div><div id="redactor_modal_inner"></div></div>');a("body").append(this.modal)}a("#redactor_modal_close").click(a.proxy(this.modalClose,this));this.hdlModalClose=a.proxy(function(a){if(a.keyCode==27)this.modalClose()},this);a(document).keyup(this.hdlModalClose);a(this.doc).keyup(this.hdlModalClose);a.ajax({dataType:"html",type:"get",url:c,success:a.proxy(function(c){a.each(RLANG,function(a,b){var d=new RegExp("%RLANG."+a+"%","gi");c=c.replace(d,b)});a("#redactor_modal_inner").html(c);a("#redactor_modal_header").html(b);if(typeof e=="function")e();var g=a("#redactor_modal").outerHeight();a("#redactor_modal").css({width:d+"px",height:"auto",marginTop:"-"+(g+10)/2+"px",marginLeft:"-"+(d+100)/2+"px"}).fadeIn("fast");if(f===true){a("#redactor_image_box").height(300).css("overflow","auto")}if(a("#redactor_tabs").size()!=0){a("#redactor_tabs a").each(function(b,c){b++;a(c).click(function(){a("#redactor_tabs a").removeClass("redactor_tabs_act");a(this).addClass("redactor_tabs_act");a(".redactor_tab").hide();a("#redactor_tab"+b).show();a("#redactor_tab_selected").val(b);var c=a("#redactor_modal").outerHeight();a("#redactor_modal").css("margin-top","-"+(c+10)/2+"px")})})}a("#redactor_btn_modal_close").click(a.proxy(this.modalClose,this))},this)})},modalClose:function(){a("#redactor_modal_close").unbind("click",this.modalClose);a("#redactor_modal").fadeOut("fast",a.proxy(function(){a("#redactor_modal_inner").html("");if(this.opts.overlay){a("#redactor_modal_overlay").hide();a("#redactor_modal_overlay").unbind("click",this.modalClose)}a(document).unbind("keyup",this.hdlModalClose);a(this.doc).unbind("keyup",this.hdlModalClose)},this))},uploadInit:function(b,c){this.uploadOptions={url:false,success:false,start:false,trigger:false,auto:false,input:false};a.extend(this.uploadOptions,c);if(a("#"+b).size()!=0&&a("#"+b).get(0).tagName=="INPUT"){this.uploadOptions.input=a("#"+b);this.element=a(a("#"+b).get(0).form)}else{this.element=a("#"+b)}this.element_action=this.element.attr("action");if(this.uploadOptions.auto){a(this.uploadOptions.input).change(a.proxy(function(){this.element.submit(function(a){return false});this.uploadSubmit()},this))}else if(this.uploadOptions.trigger){a("#"+this.uploadOptions.trigger).click(a.proxy(this.uploadSubmit,this))}},uploadSubmit:function(){this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);var b=document.createElement("div");var c='<iframe style="display:none" src="about:blank" id="'+this.id+'" name="'+this.id+'"></iframe>';b.innerHTML=c;document.body.appendChild(b);if(this.uploadOptions.start)this.uploadOptions.start();a("#"+this.id).load(a.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(b,c){if(this.uploadOptions.input){var d="redactorUploadForm"+this.id;var e="redactorUploadFile"+this.id;this.form=a('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+c+'" name="'+d+'" id="'+d+'" enctype="multipart/form-data"></form>');var f=this.uploadOptions.input;var g=a(f).clone();a(f).attr("id",e);a(f).before(g);a(f).appendTo(this.form);a(this.form).css("position","absolute");a(this.form).css("top","-2000px");a(this.form).css("left","-2000px");a(this.form).appendTo("body");this.form.submit()}else{b.attr("target",c);b.attr("method","POST");b.attr("enctype","multipart/form-data");b.attr("action",this.uploadOptions.url);this.element.submit()}},uploadLoaded:function(){var b=a("#"+this.id);if(b.contentDocument)var c=b.contentDocument;else if(b.contentWindow)var c=b.contentWindow.document;else var c=window.frames[this.id].document;if(c.location.href=="about:blank")return true;if(this.uploadOptions.success)this.uploadOptions.success(c.body.innerHTML);this.element.attr("action",this.element_action);this.element.attr("target","")},markerIE:function(){this.spanid=Math.floor(Math.random()*99999);this.execCommand("inserthtml",'<span id="span'+this.spanid+'"></span>')},oldIE:function(){if(a.browser.msie&&parseInt(a.browser.version,10)<9)return true;return false},outerHTML:function(b){return a("<p>").append(a(b).eq(0).clone()).html()},normalize:function(a){return parseInt(a.replace("px",""))}};a.fn.getDoc=function(){return a(this.data("redactor").doc)};a.fn.getFrame=function(){return this.data("redactor").$frame};a.fn.getEditor=function(){return this.data("redactor").$editor};a.fn.getCode=function(){return this.data("redactor").getCode()};a.fn.setCode=function(a){this.data("redactor").setCode(a)};a.fn.insertHtml=function(a){this.data("redactor").insertHtml(a)};a.fn.destroyEditor=function(){this.data("redactor").destroy();this.removeData("redactor")};a.fn.setFocus=function(){this.data("redactor").focus()};a.fn.execCommand=function(a,b){this.data("redactor").execCommand(a,b)}})(jQuery);(function(a){function b(b,c){this.opts=a.extend({url:false,success:false,preview:false,text:RLANG.drop_file_here,atext:RLANG.or_choose},c);this.$el=a(b)}a.fn.dragupload=function(a){return this.each(function(){var c=new b(this,a);c.init()})};b.prototype={init:function(){if(!a.browser.opera&&!a.browser.msie){this.droparea=a('<div class="redactor_droparea"></div>');this.dropareabox=a('<div class="redactor_dropareabox">'+this.opts.text+"</div>");this.dropalternative=a('<div class="redactor_dropalternative">'+this.opts.atext+"</div>");this.droparea.append(this.dropareabox);this.$el.before(this.droparea);this.$el.before(this.dropalternative);this.dropareabox.bind("dragover",a.proxy(function(){return this.ondrag()},this));this.dropareabox.bind("dragleave",a.proxy(function(){return this.ondragleave()},this));this.dropareabox.get(0).ondrop=a.proxy(function(b){b.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");var c=b.dataTransfer.files[0];var d=new FormData;d.append("file",c);a.ajax({dataType:"html",url:this.opts.url,data:d,cache:false,contentType:false,processData:false,type:"POST",success:a.proxy(function(a){if(this.opts.success!==false)this.opts.success(a);if(this.opts.preview===true)this.dropareabox.html(a)},this)})},this)}},ondrag:function(){this.dropareabox.addClass("hover");return false},ondragleave:function(){this.dropareabox.removeClass("hover");return false}}})(jQuery);(function(a){var b=/(^|<|\s)(www\..+?\..+?)(\s|>|$)/g,c=/(^|<|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|>|$)/g,d=function(){var e=this.childNodes,f=e.length;while(f--){var g=e[f];if(g.nodeType==3){var h=g.nodeValue;if(h){h=h.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(b,'$1<a href="http://$2">$2</a>$3').replace(c,'$1<a href="$2">$2</a>$5');a(g).after(h).remove()}}else if(g.nodeType==1&&!/^(a|button|textarea)$/i.test(g.tagName)){d.call(g)}}};a.fn.linkify=function(){this.each(d)}})(jQuery)
